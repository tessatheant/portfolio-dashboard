<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f0e;
    --surface: #141716;
    --surface2: #1c1f1d;
    --border: #2a2e2c;
    --accent: #7ec98f;
    --accent2: #4a9e6b;
    --text: #e8ede9;
    --text-muted: #7a8a7d;
    --red: #e07070;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    min-height: 100vh;
  }

  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(13,15,14,0.95); backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border); padding: 0 2rem;
    display: flex; align-items: center; justify-content: space-between; height: 56px;
  }

  .logo { font-family: 'Fraunces', serif; font-size: 1.3rem; font-weight: 300; color: var(--accent); letter-spacing: -0.02em; }
  .logo span { font-style: italic; color: var(--text-muted); font-size: 0.9rem; }
  .header-right { display: flex; align-items: center; gap: 1.5rem; }

  .live-dot { display: flex; align-items: center; gap: 0.4rem; color: var(--text-muted); font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; }
  .live-dot::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  nav { display: flex; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
  nav button { background: transparent; border: none; color: var(--text-muted); padding: 6px 14px; cursor: pointer; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.06em; transition: all 0.2s; border-right: 1px solid var(--border); }
  nav button:last-child { border-right: none; }
  nav button:hover, nav button.active { background: var(--accent); color: var(--bg); }

  main { max-width: 1600px; margin: 0 auto; padding: 2rem; }

  .section-label { font-family: 'Fraunces', serif; font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--accent2); margin-bottom: 1.2rem; display: flex; align-items: center; gap: 0.8rem; }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .currency-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(175px, 1fr)); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; margin-bottom: 3rem; }
  .currency-card { background: var(--surface); padding: 1.2rem; transition: background 0.2s; }
  .currency-card:hover { background: var(--surface2); }
  .currency-pair { font-size: 10px; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; }
  .currency-rate { font-family: 'Fraunces', serif; font-size: 1.6rem; font-weight: 300; line-height: 1; margin-bottom: 0.4rem; }
  .currency-change { font-size: 11px; }
  .up { color: var(--accent); } .down { color: var(--red); }
  .shimmer { color: var(--text-muted); animation: blink 1.4s infinite; }
  @keyframes blink { 0%,100%{opacity:0.4} 50%{opacity:1} }

  .stocks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(640px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
  @media (max-width: 700px) { .stocks-grid { grid-template-columns: 1fr; } }

  .stock-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; animation: fadeUp 0.4s ease both; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  .stock-card:nth-child(1){animation-delay:.05s} .stock-card:nth-child(2){animation-delay:.1s}
  .stock-card:nth-child(3){animation-delay:.15s} .stock-card:nth-child(4){animation-delay:.2s}
  .stock-card:nth-child(5){animation-delay:.25s} .stock-card:nth-child(6){animation-delay:.3s}
  .stock-card:nth-child(7){animation-delay:.35s} .stock-card:nth-child(8){animation-delay:.4s}
  .stock-card:nth-child(9){animation-delay:.45s} .stock-card:nth-child(10){animation-delay:.5s}

  .stock-header { padding: 1rem 1.2rem 0.8rem; display: flex; align-items: flex-start; justify-content: space-between; border-bottom: 1px solid var(--border); }
  .stock-ticker { font-size: 11px; letter-spacing: 0.1em; color: var(--accent); margin-bottom: 0.2rem; }
  .stock-name { font-family: 'Fraunces', serif; font-size: 1.05rem; font-weight: 300; line-height: 1.2; }
  .stock-sector { font-size: 10px; color: var(--text-muted); margin-top: 0.2rem; letter-spacing: 0.06em; }
  .stock-exchange { font-size: 10px; color: var(--text-muted); border: 1px solid var(--border); padding: 2px 6px; border-radius: 3px; white-space: nowrap; }

  .chart-controls { display: flex; padding: 0.45rem 0.8rem; border-bottom: 1px solid var(--border); background: var(--surface2); gap: 2px; }
  .tf-btn { background: transparent; border: none; color: var(--text-muted); padding: 3px 9px; cursor: pointer; font-family: 'DM Mono', monospace; font-size: 11px; border-radius: 3px; transition: all 0.15s; }
  .tf-btn:hover { color: var(--text); background: var(--border); }
  .tf-btn.active { color: var(--bg); background: var(--accent); }

  /* Chart container — must have explicit height for TradingView autosize to work */
  .chart-wrap {
    height: 320px;
    width: 100%;
    position: relative;
    background: #141716;
  }
  .chart-wrap .tradingview-widget-container,
  .chart-wrap .tradingview-widget-container > div:first-child {
    height: 100% !important;
    width: 100% !important;
  }
  /* Hide the TV copyright bar to save space */
  .chart-wrap .tradingview-widget-copyright { display: none !important; }

  .news-section { border-top: 1px solid var(--border); padding: 0.8rem 1.2rem; background: var(--bg); }
  .news-label { font-size: 10px; letter-spacing: 0.12em; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.7rem; display: flex; align-items: center; justify-content: space-between; }
  .news-ext-link { color: var(--accent2); text-decoration: none; font-size: 10px; }
  .news-ext-link:hover { color: var(--accent); }
  .news-items { display: flex; flex-direction: column; gap: 0.5rem; max-height: 145px; overflow-y: auto; }
  .news-items::-webkit-scrollbar { width: 3px; }
  .news-items::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .news-item { display: flex; gap: 0.8rem; align-items: flex-start; }
  .news-date { font-size: 10px; color: var(--text-muted); white-space: nowrap; padding-top: 1px; min-width: 55px; }
  .news-title a { font-size: 11px; line-height: 1.45; color: var(--text); text-decoration: none; transition: color 0.15s; }
  .news-title a:hover { color: var(--accent); }
  .news-msg { font-size: 11px; color: var(--text-muted); font-style: italic; }

  footer { border-top: 1px solid var(--border); padding: 1.5rem 2rem; text-align: center; color: var(--text-muted); font-size: 11px; letter-spacing: 0.06em; }
</style>
</head>
<body>

<header>
  <div class="logo">Portfolio <span>/ dashboard</span></div>
  <div class="header-right">
    <div class="live-dot">Live</div>
    <nav>
      <button class="active" onclick="showSection('all',this)">All</button>
      <button onclick="showSection('stocks',this)">Stocks</button>
      <button onclick="showSection('fx',this)">FX</button>
    </nav>
  </div>
</header>

<main>
  <div id="fx-section">
    <div class="section-label">AUD Foreign Exchange</div>
    <div class="currency-grid" id="currency-grid"></div>
  </div>
  <div id="stocks-section">
    <div class="section-label">Holdings</div>
    <div class="stocks-grid" id="stocks-grid"></div>
  </div>
</main>

<footer>
  Charts via TradingView &nbsp;·&nbsp; Rates via frankfurter.app &nbsp;·&nbsp; News via Yahoo Finance RSS &nbsp;·&nbsp; Rates auto-refresh every 60s
</footer>

<script>
// ── CONFIG ──────────────────────────────────────────────────────────────────
const STOCKS = [
  { tv: 'NYSE:XYL',       name: 'Xylem Inc',            sector: 'Water Technology',     exchange: 'NYSE',     yahoo: 'XYL' },
  { tv: 'LSE:HLMA',       name: 'Halma plc',            sector: 'Safety & Environment', exchange: 'LSE',      yahoo: 'HLMA.L' },
  { tv: 'OMXSTO:HEXA_B',  name: 'Hexagon AB',           sector: 'Digital Reality Tech', exchange: 'OMX',      yahoo: 'HEXA-B.ST' },
  { tv: 'ASX:COH',        name: 'Cochlear',             sector: 'Medical Devices',      exchange: 'ASX',      yahoo: 'COH.AX' },
  { tv: 'OMXCOP:VWS',     name: 'Vestas Wind Systems',  sector: 'Renewable Energy',     exchange: 'CPH',      yahoo: 'VWS.CO' },
  { tv: 'TSE:4901',       name: 'Fujifilm Holdings',    sector: 'Imaging & Healthcare', exchange: 'Tokyo',    yahoo: '4901.T' },
  { tv: 'NYSE:HASI',      name: 'Hannon Armstrong',     sector: 'Sustainable Finance',  exchange: 'NYSE',     yahoo: 'HASI' },
  { tv: 'TSE:6586',       name: 'Makita Corporation',   sector: 'Power Tools',          exchange: 'Tokyo',    yahoo: '6586.T' },
  { tv: 'NYSE:BEP',       name: 'Brookfield Renewable', sector: 'Renewable Energy',     exchange: 'NYSE',     yahoo: 'BEP' },
  { tv: 'EURONEXT:SU',    name: 'Schneider Electric',   sector: 'Energy Management',    exchange: 'Euronext', yahoo: 'SU.PA' },
];

const CURRENCIES = [
  { code: 'USD', name: 'US Dollar' },
  { code: 'EUR', name: 'Euro' },
  { code: 'DKK', name: 'Danish Krone' },
  { code: 'SEK', name: 'Swedish Krona' },
  { code: 'GBP', name: 'British Pound' },
  { code: 'JPY', name: 'Japanese Yen' },
  { code: 'CAD', name: 'Canadian Dollar' },
];

const TV_INTERVALS = { '1D':'D', '1W':'W', '1M':'M', '3M':'3M', '1Y':'12M', '5Y':'60M' };

// ── NAV ─────────────────────────────────────────────────────────────────────
function showSection(view, btn) {
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('fx-section').style.display     = (view==='all'||view==='fx')     ? '' : 'none';
  document.getElementById('stocks-section').style.display = (view==='all'||view==='stocks') ? '' : 'none';
}

// ── CURRENCY ─────────────────────────────────────────────────────────────────
function buildCurrencyCards() {
  document.getElementById('currency-grid').innerHTML = CURRENCIES.map(c => `
    <div class="currency-card">
      <div class="currency-pair">AUD / ${c.code}</div>
      <div class="currency-rate" id="rate-${c.code}"><span class="shimmer">···</span></div>
      <div class="currency-change" id="chg-${c.code}"></div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:0.4rem">${c.name}</div>
    </div>`).join('');
}

async function fetchRates() {
  try {
    const res = await fetch('https://api.frankfurter.app/latest?from=AUD&to=USD,EUR,DKK,SEK,GBP,JPY,CAD');
    const data = await res.json();
    if (!data.rates) return;

    let prev = {};
    try {
      // Go back a few days to avoid weekend gaps
      const d = new Date(); d.setDate(d.getDate() - 3);
      const r2 = await fetch(`https://api.frankfurter.app/${d.toISOString().split('T')[0]}?from=AUD&to=USD,EUR,DKK,SEK,GBP,JPY,CAD`);
      prev = (await r2.json()).rates || {};
    } catch(e) {}

    CURRENCIES.forEach(c => {
      const rate = data.rates[c.code]; if (!rate) return;
      document.getElementById(`rate-${c.code}`).textContent = rate.toFixed(c.code==='JPY'?2:4);
      if (prev[c.code]) {
        const pct = (rate - prev[c.code]) / prev[c.code] * 100;
        document.getElementById(`chg-${c.code}`).innerHTML =
          `<span class="${pct>=0?'up':'down'}">${pct>=0?'▲':'▼'} ${Math.abs(pct).toFixed(3)}%</span>`;
      }
    });
  } catch(e) { console.warn('FX error', e); }
}

// ── TRADINGVIEW CHARTS ───────────────────────────────────────────────────────
// Uses the official script-based widget (NOT the old iframe URL approach)
// The script tag content is the JSON config — TradingView reads it on load

function renderTVWidget(containerId, symbol, interval) {
  const wrap = document.getElementById(containerId);
  if (!wrap) return;

  // Completely replace contents so old widget is removed
  wrap.innerHTML = '';

  const outer = document.createElement('div');
  outer.className = 'tradingview-widget-container';
  outer.style.cssText = 'height:100%;width:100%';

  const inner = document.createElement('div');
  inner.className = 'tradingview-widget-container__widget';
  inner.style.cssText = 'height:100%;width:100%';
  outer.appendChild(inner);

  const script = document.createElement('script');
  script.type = 'text/javascript';
  script.async = true;
  script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
  // TradingView reads the script's textContent as the config JSON
  script.textContent = JSON.stringify({
    autosize: true,
    symbol: symbol,
    interval: TV_INTERVALS[interval] || 'D',
    timezone: 'Australia/Perth',
    theme: 'dark',
    style: '1',
    locale: 'en',
    backgroundColor: '#141716',
    gridColor: 'rgba(42,46,44,0.8)',
    withdateranges: true,
    hide_side_toolbar: true,
    allow_symbol_change: false,
    save_image: false,
    hide_volume: false,
    support_host: 'https://www.tradingview.com'
  });

  outer.appendChild(script);
  wrap.appendChild(outer);
}

function changeInterval(idx, interval, btn) {
  document.querySelectorAll('.stock-card')[idx].querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTVWidget(`chart-${idx}`, STOCKS[idx].tv, interval);
}

// ── NEWS ─────────────────────────────────────────────────────────────────────
async function fetchNews(stock, i) {
  const el = document.getElementById(`news-${i}`);
  const rssUrl = `https://feeds.finance.yahoo.com/rss/2.0/headline?s=${stock.yahoo}&region=US&lang=en-US`;
  const yahooLink = `https://finance.yahoo.com/quote/${stock.yahoo}/news/`;

  try {
    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}&count=6`);
    const data = await res.json();

    if (data.status === 'ok' && data.items?.length) {
      el.innerHTML = data.items.map(item => {
        const d = new Date(item.pubDate);
        const ds = isNaN(d.getTime()) ? '' : d.toLocaleDateString('en-AU',{day:'2-digit',month:'short'});
        return `<div class="news-item">
          <div class="news-date">${ds}</div>
          <div class="news-title"><a href="${item.link}" target="_blank" rel="noopener">${item.title}</a></div>
        </div>`;
      }).join('');
    } else {
      throw new Error('no items');
    }
  } catch(e) {
    el.innerHTML = `<div class="news-msg">Feed unavailable &nbsp;·&nbsp; <a href="${yahooLink}" target="_blank" rel="noopener" style="color:var(--accent)">View on Yahoo Finance ↗</a></div>`;
  }
}

// ── BUILD & INIT ─────────────────────────────────────────────────────────────
function buildStockCards() {
  document.getElementById('stocks-grid').innerHTML = STOCKS.map((s, i) => `
    <div class="stock-card">
      <div class="stock-header">
        <div>
          <div class="stock-ticker">${s.tv}</div>
          <div class="stock-name">${s.name}</div>
          <div class="stock-sector">${s.sector}</div>
        </div>
        <div class="stock-exchange">${s.exchange}</div>
      </div>
      <div class="chart-controls">
        ${Object.keys(TV_INTERVALS).map((tf,ti) =>
          `<button class="tf-btn${ti===0?' active':''}" onclick="changeInterval(${i},'${tf}',this)">${tf}</button>`
        ).join('')}
      </div>
      <div class="chart-wrap" id="chart-${i}"></div>
      <div class="news-section">
        <div class="news-label">
          Latest News
          <a class="news-ext-link" href="https://finance.yahoo.com/quote/${s.yahoo}/news/" target="_blank" rel="noopener">Yahoo Finance ↗</a>
        </div>
        <div class="news-items" id="news-${i}"><span class="shimmer">Loading···</span></div>
      </div>
    </div>`).join('');
}

function init() {
  buildCurrencyCards();
  fetchRates();
  setInterval(fetchRates, 60000);

  buildStockCards();

  // Stagger chart and news loads to avoid hammering external servers
  STOCKS.forEach((s, i) => {
    setTimeout(() => renderTVWidget(`chart-${i}`, s.tv, '1D'), i * 350);
    setTimeout(() => fetchNews(s, i), i * 600 + 1000);
  });
}

init();
</script>
</body>
</html>
